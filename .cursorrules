# LUẬT BẤT KHẢ XÂM PHẠM CHO DỰ ÁN QUỐC VIỆT SUPER APP (ANTIGRAVITY EDITION)

**Vai trò:** Senior React Native Architect & Compliance Officer.
**Môi trường:** Google Gemini Antigravity (Linux Cloud) & Expo Go.
**Mục tiêu:** Build thành công ngay lần đầu, chạy mượt trên Expo Go, Pass Store Review 100%.

---

## 1. QUY TẮC MÔI TRƯỜNG & THƯ VIỆN (ZERO CRASH POLICY)

> **CẢNH BÁO ĐỎ:** Môi trường này KHÔNG hỗ trợ Native Build tùy chỉnh.
> Bất kỳ vi phạm nào dưới đây sẽ khiến App CRASH ngay lập tức.

1.  **CẤM TUYỆT ĐỐI `react-native-mmkv`:**
    * Lý do: Thư viện này dùng JSI/C++, không chạy được trên Expo Go Standard.
    * Thay thế bắt buộc:
        * Token/Password: Dùng `expo-secure-store`.
        * Cache/Config: Dùng `@react-native-async-storage/async-storage`.

2.  **HẠN CHẾ IMAGE LIBRARY:**
    * Cấm `react-native-fast-image`.
    * Sử dụng: `expo-image` (Tương thích tốt nhất) hoặc `Image` chuẩn của React Native.

3.  **QUẢN LÝ BIẾN MÔI TRƯỜNG:**
    * Tạo file `src/config/env.ts` dùng `zod` để validate.
    * Nếu thiếu `EXPO_PUBLIC_API_URL`, App phải **Throw Error** ngay khi khởi động (Fail Fast).

---

## 2. QUY TẮC TUÂN THỦ STORE (STORE COMPLIANCE - FIRST PRIORITY)

> **MỆNH LỆNH:** AI phải code các tính năng này TRƯỚC khi code logic nghiệp vụ.
> Thiếu 1 trong 3 điều này = DỰ ÁN THẤT BẠI.

1.  **QUYỀN RIÊNG TƯ (APPLE & GOOGLE):**
    * **Prominent Disclosure (Google):** Trước khi gọi `requestForegroundPermissionsAsync` (Location/Camera), PHẢI hiển thị một Modal giải thích rõ ràng: "App cần quyền này để [Mục đích cụ thể]". Chỉ khi user bấm "Đồng ý" trên Modal mới được gọi API hệ thống.
    * **Permission Guards:** Luôn kiểm tra `status === 'granted'` trước khi thực thi logic. Nếu bị từ chối, phải hiện hướng dẫn User vào Cài đặt để mở lại.

2.  **XÓA TÀI KHOẢN (APPLE GUIDELINE 5.1.1):**
    * Trong `ProfileScreen`, BẮT BUỘC có nút **"Yêu cầu xóa tài khoản"** (Màu đỏ, dễ tìm).
    * Logic: Gọi API soft-delete -> Logout ngay lập tức -> Hiển thị thông báo "Dữ liệu sẽ xóa sau 30 ngày".

3.  **AN TOÀN DỮ LIỆU:**
    * Không bao giờ log `access_token` hay `password` ra Console.
    * Sử dụng `SecureStore` cho mọi dữ liệu định danh.

---

## 3. KIẾN TRÚC "ZERO TRUST" AUTHENTICATION

1.  **Tách biệt Token & User:**
    * API Login chỉ trả về `access_token`.
    * Sau khi có Token, App phải gọi ngay `GET /me` để lấy thông tin User và quyền hạn.

2.  **Kiểm tra trạng thái cấm (Ban Hammer):**
    * Trong response của `/me`, kiểm tra trường `is_deleted` hoặc `is_banned`.
    * Nếu `true` -> **Force Logout** ngay lập tức. Không cho phép User truy cập vào Home.

---

## 4. CHIẾN LƯỢC SDUI (SERVER-DRIVEN UI) TỐI GIẢN

1.  **Phạm vi:** Chỉ áp dụng SDUI cho màn hình **Home (Dashboard)**. Các màn hình chức năng (Task, Check-in) code cứng (Native Screens) để đảm bảo performance và tiến độ.
2.  **Cấu trúc Widget:**
    * Định nghĩa `WidgetRegistry` map string (JSON Type) sang Component.
    * **Fail Safe:** Nếu JSON trả về Widget lạ chưa code -> **Ẩn đi** (return null), không được làm Crash App.
3.  **Default Config:** Luôn có file `home.default.json` trong code. Nếu mất mạng hoặc API lỗi, load file này lên để User không thấy màn hình trắng.

---

## 5. CẤU TRÚC THƯ MỤC CHUẨN (CLEAN ARCHITECTURE)

```text
src/
├── app/                        # Expo Router
├── config/                     # Env & Zod Validation
├── core/
│   ├── storage/                # Facade (SecureStore + AsyncStorage) - KHÔNG MMKV
│   ├── networking/             # Axios Interceptor (Auth & Error Handling)
│   └── sdui/                   # WidgetRegistry & LayoutEngine
├── components/                 # UI Dumb Components (GlassCard, Buttons)
├── modules/                    # Feature Modules
│   ├── auth/                   # Login, Delete Account, Profile
│   ├── attendance/             # Check-in, Location Guard
│   └── task/                   # Task Management
└── types/                      # TypeScript definitions